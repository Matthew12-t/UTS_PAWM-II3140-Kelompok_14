{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Matthew/OneDrive%20-%20Institut%20Teknologi%20Bandung/seleksi%20basdat/18223096_Tugas-PAWM-Virtual-Lab/apps/web/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\r\nimport { cookies } from \"next/headers\"\r\n\r\nexport async function createServerSupabaseClient() {\r\n  const cookieStore = await cookies()\r\n\r\n  return createServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {\r\n    cookies: {\r\n      getAll() {\r\n        return cookieStore.getAll()\r\n      },\r\n      setAll(cookiesToSet) {\r\n        try {\r\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\r\n        } catch {\r\n        }\r\n      },\r\n    },\r\n  })\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,qPAAO;IAEjC,OAAO,IAAA,8SAAkB,sUAAoF;QAC3G,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM,CACR;YACF;QACF;IACF;AACF"}},
    {"offset": {"line": 74, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Matthew/OneDrive%20-%20Institut%20Teknologi%20Bandung/seleksi%20basdat/18223096_Tugas-PAWM-Virtual-Lab/apps/web/app/api/progress/route.ts"],"sourcesContent":["import { createServerSupabaseClient } from '@/lib/supabase/server'\r\nimport { NextResponse } from 'next/server'\r\n\r\nexport async function POST(request: Request) {\r\n  try {\r\n    const supabase = await createServerSupabaseClient()\r\n    const { pathwayId, status, score } = await request.json()\r\n\r\n    console.log('[API] Request:', { pathwayId, status, score })\r\n\r\n    // Get current user\r\n    const { data: { user }, error: userError } = await supabase.auth.getUser()\r\n    \r\n    console.log('[API] User:', user?.id)\r\n    \r\n    if (userError || !user) {\r\n      console.error('[API] Auth error:', userError)\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\r\n    }\r\n\r\n    const { data: existingProgress } = await supabase\r\n      .from('user_pathway_progress')\r\n      .select('id, status')\r\n      .eq('user_id', user.id)\r\n      .eq('pathway_id', pathwayId)\r\n      .single()\r\n\r\n    console.log('[API] Existing progress:', existingProgress)\r\n\r\n    let progressResult\r\n\r\n    if (existingProgress) {\r\n      const updateData: any = {\r\n        status: status || 'completed',\r\n        updated_at: new Date().toISOString()\r\n      }\r\n      \r\n      if (status === 'completed') {\r\n        updateData.completed_at = new Date().toISOString()\r\n      }\r\n      \r\n      if (score !== undefined) {\r\n        updateData.score = score\r\n      }\r\n\r\n      const { data, error } = await supabase\r\n        .from('user_pathway_progress')\r\n        .update(updateData)\r\n        .eq('id', existingProgress.id)\r\n        .select()\r\n\r\n      progressResult = { data, error }\r\n    } else {\r\n      // Insert new progress\r\n      const insertData: any = {\r\n        user_id: user.id,\r\n        pathway_id: pathwayId,\r\n        status: status || 'completed'\r\n      }\r\n      \r\n      if (status === 'completed') {\r\n        insertData.completed_at = new Date().toISOString()\r\n      }\r\n      \r\n      if (score !== undefined) {\r\n        insertData.score = score\r\n      }\r\n\r\n      const { data, error } = await supabase\r\n        .from('user_pathway_progress')\r\n        .insert(insertData)\r\n        .select()\r\n\r\n      progressResult = { data, error }\r\n    }\r\n\r\n    console.log('[API] Progress result:', progressResult)\r\n\r\n    if (progressResult.error) {\r\n      console.error('[API] Progress error:', progressResult.error)\r\n      return NextResponse.json(\r\n        { error: progressResult.error.message },\r\n        { status: 500 }\r\n      )\r\n    }\r\n\r\n    // Update user_progress\r\n    const wasNotCompleted = !existingProgress || existingProgress.status !== 'completed'\r\n    const isNowCompleted = status === 'completed'\r\n    \r\n    if (wasNotCompleted && isNowCompleted) {\r\n      const { count: totalPathways } = await supabase\r\n        .from('pathways')\r\n        .select('*', { count: 'exact', head: true })\r\n\r\n      const { count: completedPathways } = await supabase\r\n        .from('user_pathway_progress')\r\n        .select('*', { count: 'exact', head: true })\r\n        .eq('user_id', user.id)\r\n        .eq('status', 'completed')\r\n        \r\n      const { data: progressData } = await supabase\r\n        .from('user_pathway_progress')\r\n        .select('score')\r\n        .eq('user_id', user.id)\r\n        .eq('status', 'completed')\r\n        .not('score', 'is', null)\r\n\r\n      const scores = progressData?.map(p => p.score).filter(s => s !== null) || []\r\n      const averageScore = scores.length > 0 \r\n        ? scores.reduce((a, b) => a + b, 0) / scores.length \r\n        : 0\r\n\r\n      console.log('[API] Statistics:', { \r\n        totalPathways, \r\n        completedPathways, \r\n        averageScore \r\n      })\r\n\r\n      const { data: existingUserProgress } = await supabase\r\n        .from('user_progress')\r\n        .select('id')\r\n        .eq('user_id', user.id)\r\n        .maybeSingle()\r\n\r\n      if (existingUserProgress) {\r\n        await supabase\r\n          .from('user_progress')\r\n          .update({\r\n            total_experiments: totalPathways || 0,\r\n            completed_experiments: completedPathways || 0,\r\n            total_score: Math.round(averageScore * (completedPathways || 0)),\r\n            average_score: averageScore,\r\n            updated_at: new Date().toISOString()\r\n          })\r\n          .eq('id', existingUserProgress.id)\r\n      } else {\r\n        await supabase\r\n          .from('user_progress')\r\n          .insert({\r\n            user_id: user.id,\r\n            total_experiments: totalPathways || 0,\r\n            completed_experiments: completedPathways || 0,\r\n            total_score: Math.round(averageScore * (completedPathways || 0)),\r\n            average_score: averageScore\r\n          })\r\n      }\r\n\r\n      console.log('[API] User progress updated successfully')\r\n    }\r\n\r\n    const { data: currentPathway } = await supabase\r\n      .from('pathways')\r\n      .select('order_number')\r\n      .eq('id', pathwayId)\r\n      .single()\r\n\r\n    console.log('[API] Current pathway:', currentPathway)\r\n\r\n    const { data: nextPathway } = await supabase\r\n      .from('pathways')\r\n      .select('id')\r\n      .gt('order_number', currentPathway?.order_number || 0)\r\n      .order('order_number', { ascending: true })\r\n      .limit(1)\r\n      .maybeSingle()\r\n\r\n    console.log('[API] Next pathway:', nextPathway)\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: 'Progress updated successfully',\r\n      nextPathwayId: nextPathway?.id || null\r\n    })\r\n  } catch (error) {\r\n    console.error('[API] Error:', error)\r\n    return NextResponse.json(\r\n      { error: error instanceof Error ? error.message : 'Failed to update progress' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}