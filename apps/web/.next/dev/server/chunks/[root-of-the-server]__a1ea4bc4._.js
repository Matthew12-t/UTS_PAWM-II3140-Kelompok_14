module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[project]/apps/web/lib/supabase/server.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "createServerSupabaseClient",
    ()=>createServerSupabaseClient
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$supabase$2b$ssr$40$0$2e$8$2e$0_$40$supabase$2b$supabase$2d$js$40$2$2e$89$2e$0$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@supabase+ssr@0.8.0_@supabase+supabase-js@2.89.0/node_modules/@supabase/ssr/dist/module/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$supabase$2b$ssr$40$0$2e$8$2e$0_$40$supabase$2b$supabase$2d$js$40$2$2e$89$2e$0$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/@supabase+ssr@0.8.0_@supabase+supabase-js@2.89.0/node_modules/@supabase/ssr/dist/module/createServerClient.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$1$2e$1_babel$2d$plugin$2d$re_f3aa0ef20050acebca21685a51e97cbb$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.1.1_babel-plugin-re_f3aa0ef20050acebca21685a51e97cbb/node_modules/next/headers.js [app-route] (ecmascript)");
;
;
async function createServerSupabaseClient() {
    const cookieStore = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$1$2e$1_babel$2d$plugin$2d$re_f3aa0ef20050acebca21685a51e97cbb$2f$node_modules$2f$next$2f$headers$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["cookies"])();
    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f40$supabase$2b$ssr$40$0$2e$8$2e$0_$40$supabase$2b$supabase$2d$js$40$2$2e$89$2e$0$2f$node_modules$2f40$supabase$2f$ssr$2f$dist$2f$module$2f$createServerClient$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerClient"])(("TURBOPACK compile-time value", "https://zmwiyvaxmllhrxuhljlx.supabase.co"), ("TURBOPACK compile-time value", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inptd2l5dmF4bWxsaHJ4dWhsamx4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTI1ODIsImV4cCI6MjA3NjI4ODU4Mn0.x6kqZqGLLb-lUmnNF4pXyFfiuAxd1oSmzZTikuJRqWs"), {
        cookies: {
            getAll () {
                return cookieStore.getAll();
            },
            setAll (cookiesToSet) {
                try {
                    cookiesToSet.forEach(({ name, value, options })=>cookieStore.set(name, value, options));
                } catch  {}
            }
        }
    });
}
}),
"[project]/apps/web/app/api/progress/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "POST",
    ()=>POST
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/apps/web/lib/supabase/server.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$1$2e$1_babel$2d$plugin$2d$re_f3aa0ef20050acebca21685a51e97cbb$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/.pnpm/next@16.1.1_babel-plugin-re_f3aa0ef20050acebca21685a51e97cbb/node_modules/next/server.js [app-route] (ecmascript)");
;
;
async function POST(request) {
    try {
        const supabase = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$apps$2f$web$2f$lib$2f$supabase$2f$server$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerSupabaseClient"])();
        const { pathwayId, status, score } = await request.json();
        console.log('[API] Request:', {
            pathwayId,
            status,
            score
        });
        // Get current user
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        console.log('[API] User:', user?.id);
        if (userError || !user) {
            console.error('[API] Auth error:', userError);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$1$2e$1_babel$2d$plugin$2d$re_f3aa0ef20050acebca21685a51e97cbb$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        const { data: existingProgress } = await supabase.from('user_pathway_progress').select('id, status').eq('user_id', user.id).eq('pathway_id', pathwayId).single();
        console.log('[API] Existing progress:', existingProgress);
        let progressResult;
        if (existingProgress) {
            const updateData = {
                status: status || 'completed',
                updated_at: new Date().toISOString()
            };
            if (status === 'completed') {
                updateData.completed_at = new Date().toISOString();
            }
            if (score !== undefined) {
                updateData.score = score;
            }
            const { data, error } = await supabase.from('user_pathway_progress').update(updateData).eq('id', existingProgress.id).select();
            progressResult = {
                data,
                error
            };
        } else {
            // Insert new progress
            const insertData = {
                user_id: user.id,
                pathway_id: pathwayId,
                status: status || 'completed'
            };
            if (status === 'completed') {
                insertData.completed_at = new Date().toISOString();
            }
            if (score !== undefined) {
                insertData.score = score;
            }
            const { data, error } = await supabase.from('user_pathway_progress').insert(insertData).select();
            progressResult = {
                data,
                error
            };
        }
        console.log('[API] Progress result:', progressResult);
        if (progressResult.error) {
            console.error('[API] Progress error:', progressResult.error);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$1$2e$1_babel$2d$plugin$2d$re_f3aa0ef20050acebca21685a51e97cbb$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: progressResult.error.message
            }, {
                status: 500
            });
        }
        // Update user_progress
        const wasNotCompleted = !existingProgress || existingProgress.status !== 'completed';
        const isNowCompleted = status === 'completed';
        if (wasNotCompleted && isNowCompleted) {
            const { count: totalPathways } = await supabase.from('pathways').select('*', {
                count: 'exact',
                head: true
            });
            const { count: completedPathways } = await supabase.from('user_pathway_progress').select('*', {
                count: 'exact',
                head: true
            }).eq('user_id', user.id).eq('status', 'completed');
            const { data: progressData } = await supabase.from('user_pathway_progress').select('score').eq('user_id', user.id).eq('status', 'completed').not('score', 'is', null);
            const scores = progressData?.map((p)=>p.score).filter((s)=>s !== null) || [];
            const averageScore = scores.length > 0 ? scores.reduce((a, b)=>a + b, 0) / scores.length : 0;
            console.log('[API] Statistics:', {
                totalPathways,
                completedPathways,
                averageScore
            });
            const { data: existingUserProgress } = await supabase.from('user_progress').select('id').eq('user_id', user.id).maybeSingle();
            if (existingUserProgress) {
                await supabase.from('user_progress').update({
                    total_experiments: totalPathways || 0,
                    completed_experiments: completedPathways || 0,
                    total_score: Math.round(averageScore * (completedPathways || 0)),
                    average_score: averageScore,
                    updated_at: new Date().toISOString()
                }).eq('id', existingUserProgress.id);
            } else {
                await supabase.from('user_progress').insert({
                    user_id: user.id,
                    total_experiments: totalPathways || 0,
                    completed_experiments: completedPathways || 0,
                    total_score: Math.round(averageScore * (completedPathways || 0)),
                    average_score: averageScore
                });
            }
            console.log('[API] User progress updated successfully');
        }
        const { data: currentPathway } = await supabase.from('pathways').select('order_number').eq('id', pathwayId).single();
        console.log('[API] Current pathway:', currentPathway);
        const { data: nextPathway } = await supabase.from('pathways').select('id').gt('order_number', currentPathway?.order_number || 0).order('order_number', {
            ascending: true
        }).limit(1).maybeSingle();
        console.log('[API] Next pathway:', nextPathway);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$1$2e$1_babel$2d$plugin$2d$re_f3aa0ef20050acebca21685a51e97cbb$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            success: true,
            message: 'Progress updated successfully',
            nextPathwayId: nextPathway?.id || null
        });
    } catch (error) {
        console.error('[API] Error:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$1$2e$1_babel$2d$plugin$2d$re_f3aa0ef20050acebca21685a51e97cbb$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: error instanceof Error ? error.message : 'Failed to update progress'
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__a1ea4bc4._.js.map